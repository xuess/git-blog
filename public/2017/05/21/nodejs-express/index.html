<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="nodejs express笔记"/>




  <meta name="keywords" content="nodejs, 午休随笔" />










  <link rel="alternate" href="/default" title="午休随笔">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://blog.xueshanshan.com/2017/05/21/nodejs-express/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d6060b9d9c759548bc26bce7cb0612fd";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> nodejs express笔记 - 午休随笔 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">午休随笔</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">午休随笔</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          nodejs express笔记
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-21
        </span>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Express-应用生成器"><span class="toc-text">Express 应用生成器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Express-路由"><span class="toc-text">Express 路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#路由方法"><span class="toc-text">路由方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由路径"><span class="toc-text">路由路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由句柄"><span class="toc-text">路由句柄</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#响应方法"><span class="toc-text">响应方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-route"><span class="toc-text">app.route()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#express-Router"><span class="toc-text">express.Router</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用-Express-托管静态文件"><span class="toc-text">利用 Express 托管静态文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#中间件与-next"><span class="toc-text">中间件与 next</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误处理"><span class="toc-text">错误处理</span></a></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="Express-应用生成器"><a href="#Express-应用生成器" class="headerlink" title="Express 应用生成器"></a>Express 应用生成器</h2><p>通过应用生成器工具 express 可以快速创建一个应用的骨架。</p>
<p>通过如下命令安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express-generator -g</span><br></pre></td></tr></table></figure>
<p>-h 选项可以列出所有可用的命令行选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ express -h</span><br><span class="line"></span><br><span class="line">  Usage: express [options] [dir]</span><br><span class="line"></span><br><span class="line">  Options:</span><br><span class="line"></span><br><span class="line">    -h, --help           output usage information</span><br><span class="line">        --version        output the version number</span><br><span class="line">    -e, --ejs            add ejs engine support</span><br><span class="line">        --pug            add pug engine support</span><br><span class="line">        --hbs            add handlebars engine support</span><br><span class="line">    -H, --hogan          add hogan.js engine support</span><br><span class="line">    -v, --view &lt;engine&gt;  add view &lt;engine&gt; support (dust|ejs|hbs|hjs|jade|pug|twig|vash) (defaults to jade)</span><br><span class="line">    -c, --css &lt;engine&gt;   add stylesheet &lt;engine&gt; support (less|stylus|compass|sass) (defaults to plain css)</span><br><span class="line">        --git            add .gitignore</span><br><span class="line">    -f, --force          force on non-empty directory</span><br></pre></td></tr></table></figure>
<p>下面的示例就是在当前工作目录下创建一个命名为 myapp 的应用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ express myapp</span><br><span class="line"></span><br><span class="line">  warning: the default view engine will not be jade in future releases</span><br><span class="line">  warning: use `--view=jade&apos; or `--help&apos; for additional options</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   create : myapp</span><br><span class="line">   create : myapp/package.json</span><br><span class="line">   create : myapp/app.js</span><br><span class="line">   create : myapp/public</span><br><span class="line">   create : myapp/routes</span><br><span class="line">   create : myapp/routes/index.js</span><br><span class="line">   create : myapp/routes/users.js</span><br><span class="line">   create : myapp/views</span><br><span class="line">   create : myapp/views/index.jade</span><br><span class="line">   create : myapp/views/layout.jade</span><br><span class="line">   create : myapp/views/error.jade</span><br><span class="line">   create : myapp/bin</span><br><span class="line">   create : myapp/bin/www</span><br><span class="line">   create : myapp/public/javascripts</span><br><span class="line">   create : myapp/public/images</span><br><span class="line">   create : myapp/public/stylesheets</span><br><span class="line">   create : myapp/public/stylesheets/style.css</span><br><span class="line"></span><br><span class="line">   install dependencies:</span><br><span class="line">     $ cd myapp &amp;&amp; npm install</span><br><span class="line"></span><br><span class="line">   run the app:</span><br><span class="line">     $ DEBUG=myapp:* npm start</span><br></pre></td></tr></table></figure>
<p>安装依赖包与运行项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">install dependencies:</span><br><span class="line">$ cd myapp &amp;&amp; npm install</span><br><span class="line"></span><br><span class="line">run the app:</span><br><span class="line">$ DEBUG=myapp:* npm start</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意 <code>mac</code> 和 <code>win</code> 启动命令不同，上面是 <code>mac</code>的，<code>win</code> 请执行 ：<code>set DEBUG=myapp &amp; npm start</code></p>
</blockquote>
<p>然后在浏览器中打开 <a href="http://localhost:3000/" target="_blank" rel="noopener">http://localhost:3000/</a> 网址就可以看到这个应用了</p>
<p>通过 Express 应用生成器创建的应用一般都有如下目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app.js</span><br><span class="line">├── bin</span><br><span class="line">│   └── www</span><br><span class="line">├── package.json</span><br><span class="line">├── public</span><br><span class="line">│   ├── images</span><br><span class="line">│   ├── javascripts</span><br><span class="line">│   └── stylesheets</span><br><span class="line">│       └── style.css</span><br><span class="line">├── routes</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   └── users.js</span><br><span class="line">└── views</span><br><span class="line">    ├── error.jade</span><br><span class="line">    ├── index.jade</span><br><span class="line">    └── layout.jade</span><br></pre></td></tr></table></figure>
<h2 id="Express-路由"><a href="#Express-路由" class="headerlink" title="Express 路由"></a>Express 路由</h2><p>路由是指如何定义应用的端点（URIs）以及如何响应客户端的请求。</p>
<p>路由是由一个 URI、HTTP 请求（GET、POST等）和若干个句柄组成，它的结构如下： app.METHOD(path, [callback…], callback)， app 是 express 对象的一个实例， METHOD 是一个 HTTP 请求方法， path 是服务器上的路径， callback 是当路由匹配时要执行的函数。</p>
<p>下面是一个基本的路由示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">// respond with &quot;hello world&quot; when a GET request is made to the homepage</span><br><span class="line">app.get(&apos;/&apos;, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;hello world&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="路由方法"><a href="#路由方法" class="headerlink" title="路由方法"></a>路由方法</h3><p>路由方法源于 <code>HTTP</code> 请求方法，和 <code>express</code> 实例相关联。</p>
<p>下面这个例子展示了为应用跟路径定义的 <code>GET</code> 和 <code>POST</code> 请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// GET method route</span><br><span class="line">app.get(&apos;/&apos;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;GET request to the homepage&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// POST method route</span><br><span class="line">app.post(&apos;/&apos;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;POST request to the homepage&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Express 定义了如下和 HTTP 请求对应的路由方法： get, post, put, head, delete, options, trace, copy, lock, mkcol, move, purge, propfind, proppatch, unlock, report, mkactivity, checkout, merge, m-search, notify, subscribe, unsubscribe, patch, search, 和 connect。</p>
<blockquote>
<p>有些路由方法名不是合规的 JavaScript 变量名，此时使用括号记法，比如： app[‘m-search’](‘/‘, function …</p>
</blockquote>
<p><code>app.all()</code> 是一个特殊的路由方法，没有任何 <code>HTTP</code> 方法与其对应，它的作用是对于一个路径上的所有请求加载中间件。</p>
<p>在下面的例子中，来自 “<code>/secret</code>” 的请求，不管使用 <code>GET</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code> 或其他任何 <code>http</code> 模块支持的 <code>HTTP</code> 请求，句柄都会得到执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.all(&apos;/secret&apos;, function (req, res, next) &#123;</span><br><span class="line">  console.log(&apos;Accessing the secret section ...&apos;);</span><br><span class="line">  next(); // pass control to the next handler</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="路由路径"><a href="#路由路径" class="headerlink" title="路由路径"></a>路由路径</h3><p>路由路径和请求方法一起定义了请求的端点，它可以是字符串、字符串模式或者正则表达式。</p>
<p>Express 使用 <code>path-to-regexp</code> 匹配路由路径，请参考文档查阅所有定义路由路径的方法。 Express <code>Route Tester</code> 是测试基本 Express 路径的好工具，但不支持模式匹配。</p>
<blockquote>
<p>查询字符串不是路由路径的一部分。</p>
</blockquote>
<p>使用字符串的路由路径示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 匹配根路径的请求</span><br><span class="line">app.get(&apos;/&apos;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;root&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 匹配 /about 路径的请求</span><br><span class="line">app.get(&apos;/about&apos;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;about&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 匹配 /random.text 路径的请求</span><br><span class="line">app.get(&apos;/random.text&apos;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;random.text&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用字符串模式的路由路径示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 匹配 acd 和 abcd</span><br><span class="line">app.get(&apos;/ab?cd&apos;, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;ab?cd&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 匹配 abcd、abbcd、abbbcd等</span><br><span class="line">app.get(&apos;/ab+cd&apos;, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;ab+cd&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 匹配 abcd、abxcd、abRABDOMcd、ab123cd等</span><br><span class="line">app.get(&apos;/ab*cd&apos;, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;ab*cd&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 匹配 /abe 和 /abcde</span><br><span class="line">app.get(&apos;/ab(cd)?e&apos;, function(req, res) &#123;</span><br><span class="line"> res.send(&apos;ab(cd)?e&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>字符 ?、+、* 和 () 是正则表达式的子集，- 和 . 在基于字符串的路径中按照字面值解释。</p>
</blockquote>
<p>使用正则表达式的路由路径示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 匹配任何路径中含有 a 的路径：</span><br><span class="line">app.get(/a/, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;/a/&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 匹配 butterfly、dragonfly，不匹配 butterflyman、dragonfly man等</span><br><span class="line">app.get(/.*fly$/, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;/.*fly$/&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="路由句柄"><a href="#路由句柄" class="headerlink" title="路由句柄"></a>路由句柄</h3><p>可以为请求处理提供多个回调函数，其行为类似 <code>中间件</code>。唯一的区别是这些回调函数有可能调用 <code>next(&#39;route&#39;)</code> 方法而略过其他路由回调函数。可以利用该机制为路由定义前提条件，如果在现有路径上继续执行没有意义，则可将控制权交给剩下的路径。</p>
<p>路由句柄有多种形式，可以是一个函数、一个函数数组，或者是两者混合，如下所示.</p>
<p>使用一个回调函数处理路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(&apos;/example/a&apos;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;Hello from A!&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用多个回调函数处理路由（记得指定 <code>next</code> 对象）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.get(&apos;/example/b&apos;, function (req, res, next) &#123;</span><br><span class="line">  console.log(&apos;response will be sent by the next function ...&apos;);</span><br><span class="line">  next();</span><br><span class="line">&#125;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;Hello from B!&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用回调函数数组处理路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var cb0 = function (req, res, next) &#123;</span><br><span class="line">  console.log(&apos;CB0&apos;);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var cb1 = function (req, res, next) &#123;</span><br><span class="line">  console.log(&apos;CB1&apos;);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var cb2 = function (req, res) &#123;</span><br><span class="line">  res.send(&apos;Hello from C!&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(&apos;/example/c&apos;, [cb0, cb1, cb2]);</span><br></pre></td></tr></table></figure>
<p>混合使用函数和函数数组处理路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var cb0 = function (req, res, next) &#123;</span><br><span class="line">  console.log(&apos;CB0&apos;);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var cb1 = function (req, res, next) &#123;</span><br><span class="line">  console.log(&apos;CB1&apos;);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(&apos;/example/d&apos;, [cb0, cb1], function (req, res, next) &#123;</span><br><span class="line">  console.log(&apos;response will be sent by the next function ...&apos;);</span><br><span class="line">  next();</span><br><span class="line">&#125;, function (req, res) &#123;</span><br><span class="line">  res.send(&apos;Hello from D!&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="响应方法"><a href="#响应方法" class="headerlink" title="响应方法"></a>响应方法</h3><p>下表中响应对象（res）的方法向客户端返回响应，终结请求响应的循环。如果在路由句柄中一个方法也不调用，来自客户端的请求会一直挂起。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述 </th>
</tr>
</thead>
<tbody>
<tr>
<td>res.download()</td>
<td>提示下载文件。</td>
</tr>
<tr>
<td>res.end()</td>
<td>终结响应处理流程。</td>
</tr>
<tr>
<td>res.json()</td>
<td>发送一个 JSON 格式的响应。</td>
</tr>
<tr>
<td>res.jsonp()</td>
<td>发送一个支持 JSONP 的 JSON 格式的响应。</td>
</tr>
<tr>
<td>res.redirect()</td>
<td>重定向请求。</td>
</tr>
<tr>
<td>res.render()</td>
<td>渲染视图模板。</td>
</tr>
<tr>
<td>res.send()</td>
<td>发送各种类型的响应。</td>
</tr>
<tr>
<td>res.sendFile()</td>
<td>以八位字节流的形式发送文件。 sendfile(‘login.html’);</td>
</tr>
<tr>
<td>res.sendStatus()</td>
<td>设置响应状态代码，并将其以字符串形式作为响应体的一部分发送。</td>
</tr>
</tbody>
</table>
<h3 id="app-route"><a href="#app-route" class="headerlink" title="app.route()"></a>app.route()</h3><p>可使用 <code>app.route()</code> 创建路由路径的链式路由句柄。由于路径在一个地方指定，这样做有助于创建模块化的路由，而且减少了代码冗余和拼写错误。请参考 <code>Router()</code> 文档 了解更多有关路由的信息。</p>
<p>下面这个示例程序使用 <code>app.route()</code> 定义了链式路由句柄。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.route(&apos;/book&apos;)</span><br><span class="line">  .get(function(req, res) &#123;</span><br><span class="line">    res.send(&apos;Get a random book&apos;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .post(function(req, res) &#123;</span><br><span class="line">    res.send(&apos;Add a book&apos;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .put(function(req, res) &#123;</span><br><span class="line">    res.send(&apos;Update the book&apos;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="express-Router"><a href="#express-Router" class="headerlink" title="express.Router"></a>express.Router</h3><p>可使用 <code>express.Router</code> 类创建模块化、可挂载的路由句柄。<code>Router</code> 实例是一个完整的中间件和路由系统，因此常称其为一个 “<code>mini-app</code>”。</p>
<p>下面的实例程序创建了一个路由模块，并加载了一个中间件，定义了一些路由，并且将它们挂载至应用的路径上。</p>
<p>在 <code>app</code> 目录下创建名为 <code>birds.js</code> 的文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var router = express.Router();</span><br><span class="line"></span><br><span class="line">// 该路由使用的中间件</span><br><span class="line">router.use(function timeLog(req, res, next) &#123;</span><br><span class="line">  console.log(&apos;Time: &apos;, Date.now());</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line">// 定义网站主页的路由</span><br><span class="line">router.get(&apos;/&apos;, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;Birds home page&apos;);</span><br><span class="line">&#125;);</span><br><span class="line">// 定义 about 页面的路由</span><br><span class="line">router.get(&apos;/about&apos;, function(req, res) &#123;</span><br><span class="line">  res.send(&apos;About birds&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">module.exports = router;</span><br></pre></td></tr></table></figure>
<p>然后在应用中加载路由模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var birds = require(&apos;./birds&apos;);</span><br><span class="line">...</span><br><span class="line">app.use(&apos;/birds&apos;, birds);</span><br></pre></td></tr></table></figure>
<p>应用即可处理发自 <code>/birds</code> 和 <code>/birds/about</code> 的请求，并且调用为该路由指定的 <code>timeLog</code> 中间件。</p>
<h2 id="利用-Express-托管静态文件"><a href="#利用-Express-托管静态文件" class="headerlink" title="利用 Express 托管静态文件"></a>利用 Express 托管静态文件</h2><p>通过 <code>Express</code> 内置的 <code>express.static</code> 可以方便地托管静态文件，例如<code>图片</code>、<code>CSS</code>、<code>JavaScript</code> 文件等。</p>
<p>将静态资源文件所在的目录作为参数传递给 <code>express.static</code> 中间件就可以提供静态资源文件的访问了。例如，假设在 <code>public</code> 目录放置了<code>图片</code>、<code>CSS</code> 和 <code>JavaScript</code> 文件，你就可以：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(&apos;public&apos;));</span><br></pre></td></tr></table></figure>
<p>现在，<code>public</code> 目录下面的文件就可以访问了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/images/kitten.jpg</span><br><span class="line">http://localhost:3000/css/style.css</span><br><span class="line">http://localhost:3000/js/app.js</span><br><span class="line">http://localhost:3000/images/bg.png</span><br><span class="line">http://localhost:3000/hello.html</span><br></pre></td></tr></table></figure>
<blockquote>
<p>所有文件的路径都是相对于存放目录的，因此，存放静态文件的目录名不会出现在 <code>URL</code> 中。</p>
</blockquote>
<p>如果你的静态资源存放在多个目录下面，你可以多次调用 <code>express.static</code> 中间件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(&apos;public&apos;));</span><br><span class="line">app.use(express.static(&apos;files&apos;));</span><br></pre></td></tr></table></figure>
<p>访问静态资源文件时，<code>express.static</code> 中间件会根据目录添加的顺序查找所需的文件。</p>
<p>如果你希望所有通过 <code>express.static</code> 访问的文件都存放在一个“<code>虚拟（virtual）</code>”目录（即目录根本不存在）下面，可以通过为静态资源目录指定一个挂载路径的方式来实现，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(&apos;/static&apos;, express.static(&apos;public&apos;));</span><br></pre></td></tr></table></figure>
<p>现在，你就爱可以通过带有 “<code>/static</code>” 前缀的地址来访问 <code>public</code> 目录下面的文件了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/static/images/kitten.jpg</span><br><span class="line">http://localhost:3000/static/css/style.css</span><br><span class="line">http://localhost:3000/static/js/app.js</span><br><span class="line">http://localhost:3000/static/images/bg.png</span><br><span class="line">http://localhost:3000/static/hello.html</span><br></pre></td></tr></table></figure>
<h3 id="中间件与-next"><a href="#中间件与-next" class="headerlink" title="中间件与 next"></a>中间件与 next</h3><p><code>express</code> 中的中间件（middleware）就是用来处理请求的，当一个中间件处理完，可以通过调用 <code>next()</code> 传递给下一个中间件，如果没有调用 <code>next()</code>，则请求不会往下传递，如内置的 <code>res.render</code> 其实就是渲染完 <code>html</code> 直接返回给客户端，没有调用 <code>next()</code>，从而没有传递给下一个中间件。看个小例子，修改 <code>index.js</code> 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(function(req, res, next) &#123;</span><br><span class="line">  console.log(&apos;1&apos;);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(req, res, next) &#123;</span><br><span class="line">  console.log(&apos;2&apos;);</span><br><span class="line">  res.status(200).end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<p>此时访问 localhost:3000，终端会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
<p>通过 <code>app.use</code> 加载中间件，在中间件中通过 <code>next</code> 将请求传递到下一个中间件，<code>next</code> 可接受一个参数接收错误信息，如果使用了 <code>next(error)</code>，则会返回错误而不会传递到下一个中间件，修改 <code>index.js</code> 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(function(req, res, next) &#123;</span><br><span class="line">  console.log(&apos;1&apos;);</span><br><span class="line">  next(new Error(&apos;haha&apos;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(req, res, next) &#123;</span><br><span class="line">  console.log(&apos;2&apos;);</span><br><span class="line">  res.status(200).end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<p>报错信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Error: haha</span><br><span class="line">    at /Users/shanshanxue/Documents/workspace/aym_admin_nav/index.js:6:8</span><br><span class="line">    at Layer.handle [as handle_request] (/Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at trim_prefix (/Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/index.js:317:13)</span><br><span class="line">    at /Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/index.js:284:7</span><br><span class="line">    at next (/Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/index.js:275:10)</span><br><span class="line">    at expressInit (/Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/middleware/init.js:40:5)</span><br><span class="line">    at Layer.handle [as handle_request] (/Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at trim_prefix (/Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/index.js:317:13)</span><br><span class="line">    at /Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/index.js:284:7</span><br><span class="line">    at next (/Users/shanshanxue/Documents/workspace/aym_admin_nav/node_modules/express/lib/router/index.js:275:10)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>小提示：<code>app.use</code> 有非常灵活的使用方式，详情见 <a href="http://expressjs.com/en/4x/api.html#app.use" target="_blank" rel="noopener">官方文档</a>。</p>
</blockquote>
<p><code>express</code> 有成百上千的第三方中间件，在开发过程中我们首先应该去 <code>npm</code> 上寻找是否有类似实现的中间件，尽量避免造轮子，节省开发时间。下面给出几个常用的搜索 npm 模块的网站：</p>
<ol>
<li><a href="http://npmjs.com" target="_blank" rel="noopener">http://npmjs.com</a>(npm 官网)</li>
<li><a href="http://node-modules.com" target="_blank" rel="noopener">http://node-modules.com</a></li>
<li><a href="https://npms.io" target="_blank" rel="noopener">https://npms.io</a></li>
<li><a href="https://nodejsmodules.org" target="_blank" rel="noopener">https://nodejsmodules.org</a></li>
</ol>
<blockquote>
<p>小提示：<code>express@4</code> 之前的版本基于 <code>connect</code> 这个模块实现的中间件的架构，<code>express@4</code> 及以上的版本则移除了对 <code>connect</code> 的依赖自己实现了，理论上基于 <code>connect</code> 的中间件（通常以 <code>connect-</code> 开头，如 <code>connect-mongo</code>）仍可结合 <code>express</code> 使用。</p>
<p>注意：中间件的加载顺序很重要！比如：通常把日志中间件放到比较靠前的位置，后面将会介绍的 <code>connect-flash</code> 中间件是基于 <code>session</code> 的，所以需要在 <code>express-session</code> 后加载。</p>
</blockquote>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>上面的例子中，应用程序为我们自动返回了错误栈信息（<code>express</code> 内置了一个默认的错误处理器），假如我们想手动控制返回的错误内容，则需要加载一个自定义错误处理的中间件，修改 <code>index.js</code> 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&apos;express&apos;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(function(req, res, next) &#123;</span><br><span class="line">  console.log(&apos;1&apos;);</span><br><span class="line">  next(new Error(&apos;haha&apos;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(req, res, next) &#123;</span><br><span class="line">  console.log(&apos;2&apos;);</span><br><span class="line">  res.status(200).end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">//错误处理</span><br><span class="line">app.use(function(err, req, res, next) &#123;</span><br><span class="line">  console.error(err.stack);</span><br><span class="line">  res.status(500).send(&apos;Something broke!&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<p>此时访问 <code>localhost:3000</code>，浏览器会显示 <code>Something broke!</code>。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://blog.xueshanshan.com">xuess</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://blog.xueshanshan.com/2017/05/21/nodejs-express/">http://blog.xueshanshan.com/2017/05/21/nodejs-express/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/nodejs/">nodejs</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/05/22/es6-for-of-for-in/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">forEach、for-in与for-of的区别</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/04/24/linux-command/">
        <span class="next-text nav-default">linux 重用命令整理</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:wuniu2010@126.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/xuess" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="https://weibo.com/test5433" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
        
          <a href="https://www.zhihu.com/people/shan-xue-74/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2016 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">xuess</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://blog.xueshanshan.com/2017/05/21/nodejs-express/';
        this.page.identifier = '2017/05/21/nodejs-express/';
        this.page.title = 'nodejs express笔记';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//xueshanshan-com.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
